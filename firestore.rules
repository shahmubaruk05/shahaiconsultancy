rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    // USERS
    match /users/{uid} {
      // Own profile or admin
      allow read, update, delete: if isAdmin() || (isSignedIn() && request.auth.uid == uid);
      allow create: if isSignedIn();
    }

    // Secure all user-specific data under the /users/{userId} path.
    match /users/{userId}/{document=**} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }

    // PUBLIC INTAKE FORM (client je form fillup kore)
    match /intakes/{intakeId} {
      // Public form theke submit hobe, tai create sobar jonno open
      allow create: if true;
      // Intake gulo sudhu admin dekhbe / edit korbe
      allow read, update, delete: if isAdmin();
    }

    // ORDERS / TICKETS (admin panel)
    match /orders/{orderId} {
      allow read, write: if isAdmin();
    }
    
    match /orders/{orderId}/{document=**} {
        allow read, write: if isAdmin();
    }

    // INVOICES (public payment page + admin manage)
    match /invoices/{invoiceId} {
      // Public payment link theke invoice details dekhte parbe
      allow get: if true;
      // List, create, update, delete sudhu admin
      allow list, create, update, delete: if isAdmin();
    }

    // PAYMENTS (pricing page bKash / PayPal + invoice payment confirmation)
    match /payments/{paymentId} {
      // Payment submit korar somoy client der ke doc create korte debe
      allow create: if true;
      // Read / update / delete sudhu admin
      allow read, update, delete: if isAdmin();
    }
    
    match /invoicePayments/{paymentId} {
        allow create: if true;
        allow read, update, delete: if isAdmin();
    }


    // Optional: bKash specific collection (jodi use kore thaken)
    match /bkashPayments/{id} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }

    // Optional: PayPal specific collection (jodi thake)
    match /paypalPayments/{id} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }
    
    match /aiUsageLogs/{logId} {
      allow create: if true;
      allow read: if isAdmin();
    }

    // BLOG POSTS
    match /blogPosts/{postId} {
      allow read: if true;        // Public blog
      allow write: if isAdmin();  // Create/update/delete only admin
    }
  }
}
